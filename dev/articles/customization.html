<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Customization • pillar</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Customization">
<meta property="og:description" content="pillar">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">pillar</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">1.4.99.9002</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/pillar-package.html#package-options">Options</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/pillar/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="customization_files/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="customization_files/htmlwidgets-1.5.2/htmlwidgets.js"></script><script src="customization_files/d3-3.3.8/d3.min.js"></script><script src="customization_files/dagre-0.4.0/dagre-d3.min.js"></script><link href="customization_files/mermaid-0.3.0/dist/mermaid.css" rel="stylesheet">
<script src="customization_files/mermaid-0.3.0/dist/mermaid.slim.min.js"></script><link href="customization_files/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="customization_files/chromatography-0.1/chromatography.js"></script><script src="customization_files/DiagrammeR-binding-1.0.6.1/DiagrammeR.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Customization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/pillar/blob/master/vignettes/customization.Rmd"><code>vignettes/customization.Rmd</code></a></small>
      <div class="hidden name"><code>customization.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pillar.r-lib.org/">pillar</a></span><span class="op">)</span></pre></div>
<p>This draft describes a new backward-compatible design for making the appearance of a pillar more extensible.</p>
<p>The design consists of two parts:</p>
<ol style="list-style-type: decimal">
<li>Moving all formatting code into pillar</li>
<li>Adding extension points for formatting individual pillars</li>
</ol>
<div id="moving-all-formatting-code-into-pillar" class="section level2">
<h2 class="hasAnchor">
<a href="#moving-all-formatting-code-into-pillar" class="anchor"></a>Moving all formatting code into pillar</h2>
<div id="advantages" class="section level3">
<h3 class="hasAnchor">
<a href="#advantages" class="anchor"></a>Advantages</h3>
<ul>
<li>Code that implements formatting for tables no longer needs tibble</li>
<li>All formatting code in one package</li>
<li>Simplify and document formatting code along the way</li>
<li>New <code>as_tbl()</code> for attaching the <code>"tbl"</code> class to arbitrary objects (e.g. data frames or data tables) for printing</li>
</ul>
</div>
<div id="implementation" class="section level3">
<h3 class="hasAnchor">
<a href="#implementation" class="anchor"></a>Implementation</h3>
<p><code><a href="../reference/format_tbl.html">format.tbl()</a></code> retains its semantics. For compatibility it returns a character vector with one element per line.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="co">#' @export</span>
<span class="va">format.tbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">setup</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_format_setup.html">tbl_format_setup</a></span><span class="op">(</span><span class="va">x</span>, width <span class="op">=</span> <span class="va">width</span>, n <span class="op">=</span> <span class="va">n</span>, n_extra <span class="op">=</span> <span class="va">n_extra</span><span class="op">)</span>
  <span class="va">header</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_format_header.html">tbl_format_header</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">setup</span><span class="op">)</span>
  <span class="va">body</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_format_body.html">tbl_format_body</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">setup</span><span class="op">)</span>
  <span class="va">footer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_format_footer.html">tbl_format_footer</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">setup</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">header</span>, <span class="va">body</span>, <span class="va">footer</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="new-generics" class="section level3">
<h3 class="hasAnchor">
<a href="#new-generics" class="anchor"></a>New generics</h3>
<p><code><a href="../reference/tbl_format_setup.html">tbl_format_setup()</a></code> takes the role of the (then superseded) <code>trunc_mat()</code>. The default mimics <code>trunc_mat()</code> but returns a stable data structure that is well documented. Classes that need to do more when setting up the printing implement a method.</p>
<p>Contrary to the existing logic, the width would be baked into the <code>setup</code> object. I haven’t seen a use case for formatting the same prepared object with multiple widths.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="va">tbl_format_setup.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">trunc_mat</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p><code><a href="../reference/tbl_format_header.html">tbl_format_header()</a></code> in the default implementation formats the output of <code><a href="../reference/tbl_sum.html">tbl_sum()</a></code>. The implementer is expected to apply <code><a href="../reference/style_num.html">style_subtle()</a></code> in case the class wants to add color or other styling.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">tbl_format_header.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">sum</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tbl_sum.html">tbl_sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
  <span class="fu"><a href="../reference/style_num.html">style_subtle</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">sum</span><span class="op">)</span>, <span class="st">": "</span>, <span class="va">sum</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></pre></div>
<p><code><a href="../reference/tbl_format_body.html">tbl_format_body()</a></code> formats the colonnade prepared in the setup. The implementation is shown further below.</p>
<p><code><a href="../reference/tbl_format_footer.html">tbl_format_footer()</a></code> is copied from tibble. The implementer is expected to apply <code><a href="../reference/style_num.html">style_subtle()</a></code> in case the class wants to add color or other styling.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">tbl_format_footer.default</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/style_num.html">style_subtle</a></span><span class="op">(</span><span class="fu">format_footer</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">format_footer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Copy implementation from tibble</span>
<span class="op">}</span></pre></div>
</div>
<div id="data-flow" class="section level3">
<h3 class="hasAnchor">
<a href="#data-flow" class="anchor"></a>Data flow</h3>
<p>Boxes are functions and methods. Solid lines are function calls. Dotted lines are inputs to function calls.</p>
<div id="htmlwidget-dc0876a64dafdfafeeb8" style="width:700px;height:432.632880098888px;" class="DiagrammeR html-widget"></div>
<script type="application/json" data-for="htmlwidget-dc0876a64dafdfafeeb8">{"x":{"diagram":"graph TD\n  print.tbl --> format.tbl\n  format.tbl -- \"options -> n; n_extra\" --> tbl_format_setup\n  format.tbl --> tbl_format_header\n  format.tbl --> tbl_format_body\n  format.tbl --> tbl_format_footer\n  tbl_format_setup -.-> tbl_format_header\n  tbl_format_setup -.-> tbl_format_body\n  tbl_format_setup -.-> tbl_format_footer\n  format.tbl --> c\n  tbl_format_header -.-> c\n  tbl_format_body -.-> c\n  tbl_format_footer -.-> c"},"evals":[],"jsHooks":[]}</script>
</div>
</div>
<div id="adding-extension-points-for-formatting-individual-pillars" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-extension-points-for-formatting-individual-pillars" class="anchor"></a>Adding extension points for formatting individual pillars</h2>
<div id="constraints-and-design-goals" class="section level3">
<h3 class="hasAnchor">
<a href="#constraints-and-design-goals" class="anchor"></a>Constraints and design goals</h3>
<ul>
<li>A pillar is rarely shown individually, most often it is part of a colonnade.</li>
<li>A colonnade also is rarely shown individually, most often it is part of a larger structure like a tibble.</li>
<li>All pillars in a colonnade are shown in a similar way, a single controller can decide the appearance of all pillars.</li>
<li>Pillars in a colonnade are either all named or all unnamed.</li>
<li>Pillars can adapt their width to the available space. Computation of minimum and maximum width can happen before formatting the actual data. For performance reasons, <code><a href="../reference/colonnade.html">colonnade()</a></code> will not construct pillar objects it doesn’t need.</li>
<li>A pillar has a header (=capital), body (=shaft), footer (=basis, currently not used). Design should follow <code>cnd_header()</code>, <code>cnd_body()</code> and <code>cnd_footer()</code>. These components can be of different height, will be top-aligned when printing.</li>
<li>Pillars are always shown from left to right, no “holes” in the colonnade. If the first column consumes all available space, the remaining columns are not shown, even if they all would fit if the first column is omitted.</li>
<li>Printing pillars should take time proportional to the number of characters printed, and be “fast enough”.</li>
<li>Customizing parts of the display (e.g. omit type, add more information) should be easy.</li>
<li>Existing infrastructure should be supported.</li>
<li>
<em>NEW</em>: Support arbitrary components of a pillar, title, type, data, … .</li>
<li>
<em>NEW</em>: Columns containing data frames and matrices remain supported.</li>
</ul>
</div>
<div id="new-generics-1" class="section level3">
<h3 class="hasAnchor">
<a href="#new-generics-1" class="anchor"></a>New generics</h3>
<p>Because printing is now internal to pillar, there’s no need to touch <code><a href="../reference/colonnade.html">colonnade()</a></code>. Internally, the object to be printed is used as <code>controller</code> argument. The default controller mimics current behavior.</p>
<p>Two new generics, <code>ctl_new_pillar()</code> and <code>ctl_new_single_pillar()</code>, dispatch on that controller. The first method needs to be aware of packed columns (matrices and data frames), the second will be called only for 1D objects.</p>
<p>Apart from the controller, these generics receive the object, the formatted name (which can be a vector in the case of packed data frames or matrices), and the remaining width (which can also be a vector in the case of multiple tiers, if <code>getOption("width") &lt; getOption("tibble.width")</code>). Both generics return a <code>"pillar"</code> object, or <code>NULL</code> if the minimum width of the pillar doesn’t fit the remaining width.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">ctl_new_pillar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">controller</span>, <span class="va">x</span>, <span class="va">width</span>, <span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html">UseMethod</a></span><span class="op">(</span><span class="st">"ctl_new_pillar"</span><span class="op">)</span>
<span class="op">}</span>

<span class="co">#' @export</span>
<span class="va">ctl_new_pillar.tbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">controller</span>, <span class="va">x</span>, <span class="va">width</span>, <span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">is.data.frame</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">new_data_frame_pillar</span><span class="op">(</span><span class="va">x</span>, <span class="va">controller</span>, <span class="va">width</span>, title <span class="op">=</span> <span class="va">title</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">is.matrix</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">new_matrix_pillar</span><span class="op">(</span><span class="va">x</span>, <span class="va">controller</span>, <span class="va">width</span>, title <span class="op">=</span> <span class="va">title</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">is.array</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">...</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu">ctl_new_single_pillar</span><span class="op">(</span><span class="va">controller</span>, <span class="va">x</span>, <span class="va">width</span>, <span class="va">...</span>, title <span class="op">=</span> <span class="va">title</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">ctl_new_single_pillar.tbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">controller</span>, <span class="va">x</span>, <span class="va">width</span>, <span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/pillar.html">pillar</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">title</span>, <span class="va">width</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="the-pillar-class" class="section level3">
<h3 class="hasAnchor">
<a href="#the-pillar-class" class="anchor"></a>The <code>"pillar"</code> class</h3>
<p>Objects of class <code>"pillar"</code> are internally a named lists of their components. The default components are <code>title</code> (may be missing), <code>type</code>, and <code>data</code>. Each component is a <code>"pillar_box"</code>, as described below. Implementations may add new components or modify existing components.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">new_pillar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">base</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">...</span>, <span class="va">class</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/modifyList.html">modifyList</a></span><span class="op">(</span><span class="va">base</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span>,
    class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">class</span>, <span class="st">"pillar"</span><span class="op">)</span>
  <span class="op">)</span>
<span class="op">}</span></pre></div>
<p>This allows e.g.:</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="va">ctl_new_single_pillar.foo_controller</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">controller</span>, <span class="va">x</span>, <span class="va">width</span>, <span class="va">...</span>, <span class="va">title</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">out</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/UseMethod.html">NextMethod</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu">new_pillar</span><span class="op">(</span><span class="va">out</span>, capital <span class="op">=</span> <span class="cn">NULL</span>, footer <span class="op">=</span> <span class="va">...</span>, class <span class="op">=</span> <span class="st">"foo_pillar"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="the-pillar_box-class" class="section level3">
<h3 class="hasAnchor">
<a href="#the-pillar_box-class" class="anchor"></a>The <code>"pillar_box"</code> class</h3>
<p>An object of the <code>"pillar_box"</code> class captures contents that can be fitted in a rectangle. Each box consists of one or multiple cells that are aligned horizontally (with one space inbetween) when printed. Each cell has a maximum (=desired) width and may have a minimum width if the contents are compressible. The box object stores the width of the cells as an attribute.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="va">new_pillar_box</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">width</span>, <span class="va">min_width</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/structure.html">structure</a></span><span class="op">(</span>
    <span class="va">x</span>,
    width <span class="op">=</span> <span class="va">width</span>,
    min_width <span class="op">=</span> <span class="va">min_width</span>
    <span class="co"># keep class attribute from x</span>
  <span class="op">)</span>
<span class="op">}</span>

<span class="va">get_cell_widths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"width"</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">get_cell_min_widths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"min_width"</span><span class="op">)</span> <span class="op">%||%</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"width"</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>The cells may be stored as a list with one element per cell (for <code>type</code> and <code>data</code> components), or as a hierarchy of boxes (for the <code>name</code> component). In the latter case, <code>length(x) &lt; length(get_cell_widths(x))</code>, and each element must be a box.</p>
<p>Extraction of a contiguous range of cells is supported.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">get_cells</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html">stopifnot</a></span><span class="op">(</span><span class="va">from</span> <span class="op">&lt;=</span> <span class="va">to</span><span class="op">)</span>
  
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu">get_cell_widths</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu">get_cells_for_hierarchy</span><span class="op">(</span><span class="va">x</span>, <span class="va">from</span>, <span class="va">to</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu">seq2</span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span>
    <span class="fu">new_pillar_box</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>, <span class="fu">get_cell_widths</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span>, <span class="fu">get_cell_min_widths</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[</span><span class="va">idx</span><span class="op">]</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">get_cells_for_hierarchy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">from</span>, <span class="va">to</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">lengths</span> <span class="op">&lt;-</span> <span class="fu">map_int</span><span class="op">(</span><span class="va">x</span>, <span class="kw">function</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu">get_cell_widths</span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/bincode.html">.bincode</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">to</span><span class="op">)</span>, <span class="va">lengths</span><span class="op">)</span>
  <span class="va">from_idx</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
  <span class="va">to_idx</span> <span class="op">&lt;-</span> <span class="va">idx</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>
  
  <span class="va">...</span>
<span class="op">}</span></pre></div>
</div>
<div id="sub-pillars-and-their-widths" class="section level3">
<h3 class="hasAnchor">
<a href="#sub-pillars-and-their-widths" class="anchor"></a>Sub-pillars and their widths</h3>
<p>If the components of a pillar are boxes with multiple cells, the pillar can be decomposed into sub-pillars that consist of corresponding cells from each component box. For each sub-pillar, its width can be computed as a maximum of the cell widths of the individual boxes.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="va">pillar_get_widths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">exec</span><span class="op">(</span><span class="va">pmax</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu">map</span><span class="op">(</span><span class="va">x</span>, <span class="va">get_cell_widths</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pillar_get_min_widths</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">exec</span><span class="op">(</span><span class="va">pmax</span>, <span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu">map</span><span class="op">(</span><span class="va">x</span>, <span class="va">get_cell_min_widths</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></pre></div>
<p>Alternatively, widths can be computed once when constructing the pillar object and stored in an attribute.</p>
</div>
<div id="implementation-sketch" class="section level3">
<h3 class="hasAnchor">
<a href="#implementation-sketch" class="anchor"></a>Implementation sketch</h3>
<ul>
<li>The width of the tier(s) for printing is computed from <code><a href="https://rdrr.io/r/base/options.html">getOption("tibble.width")</a></code> and <code><a href="https://rdrr.io/r/base/options.html">getOption("width")</a></code>.</li>
<li>We start with the assumption that each column consumes at least one character, with the space between the columns. This gives an upper bound for the number of columns and allows preallocating memory.</li>
<li>The new <code>colonnade2()</code> gives us the representation of the entire data frame.</li>
<li>The new implementation seamlessly supports display of matrices via <code>new_matrix_pillar()</code>.</li>
<li>After the final list of pillars is known, they are distributed using the existing implementation to make use of excess space (not shown here).</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">colonnade2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">controller</span>, <span class="va">has_row_id</span>, <span class="va">width</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="co"># Reserve space for rowid column in each tier</span>
  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu">is_false</span><span class="op">(</span><span class="va">has_row_id</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rowid_width</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">trunc</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span>
    <span class="va">width</span> <span class="op">&lt;-</span> <span class="va">width</span> <span class="op">-</span> <span class="va">rowid_width</span> <span class="op">-</span> <span class="fl">1</span>
    <span class="va">width</span> <span class="op">&lt;-</span> <span class="va">width</span><span class="op">[</span><span class="va">width</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>
  <span class="op">}</span>
  
  <span class="fu">new_data_frame_pillar</span><span class="op">(</span><span class="va">x</span>, <span class="va">controller</span>, <span class="va">width</span>, title <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>
<span class="op">}</span>


<span class="va">new_data_frame_pillar</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">controller</span>, <span class="va">width</span>, <span class="va">title</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">max_n_pillars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">width</span> <span class="op">%/%</span> <span class="fl">2</span><span class="op">)</span>
  <span class="va">pillars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="va">max_n_pillars</span><span class="op">)</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Call ctl_new_pillar() only for objects that can fit</span>
    <span class="va">pillar</span> <span class="op">&lt;-</span> <span class="fu">ctl_new_pillar</span><span class="op">(</span>
      <span class="va">controller</span>, <span class="va">x</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="va">width</span>, 
      title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">title</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
    <span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">pillar</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="co"># NULL return: doesn't fit</span>
      <span class="kw">break</span>
    <span class="op">}</span>
    
    <span class="co"># Compute remaining width</span>
    <span class="va">width</span> <span class="op">&lt;-</span> <span class="fu">deduct_width</span><span class="op">(</span><span class="va">width</span>, <span class="fu">pillar_get_min_widths</span><span class="op">(</span><span class="va">pillar</span><span class="op">)</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="co"># NULL return: current pillar doesn't fit</span>
      <span class="kw">break</span>
    <span class="op">}</span>

    <span class="va">pillars</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">pillar</span>
  <span class="op">}</span>
  
  <span class="va">pillars</span> <span class="op">&lt;-</span> <span class="fu">compact</span><span class="op">(</span><span class="va">pillars</span><span class="op">)</span>
  
  <span class="va">widths</span> <span class="op">&lt;-</span> <span class="fu">reduce</span><span class="op">(</span><span class="va">pillars</span>, <span class="va">pillar_get_widths</span><span class="op">)</span>
  <span class="va">min_widths</span> <span class="op">&lt;-</span> <span class="fu">reduce</span><span class="op">(</span><span class="va">pillars</span>, <span class="va">pillar_get_min_widths</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Can be rewritten with a repeat loop</span>
<span class="va">deduct_width</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">width</span>, <span class="va">consumed_widths</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">consumed_widths</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># All sub-pillars distributed</span>
    <span class="va">width</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">width</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Doesn't fit</span>
    <span class="cn">NULL</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">width</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="va">consumed_widths</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
    <span class="co"># Fits first tier</span>
    <span class="fu">deduct_width</span><span class="op">(</span>
      <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">width</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">-</span> <span class="va">consumed_widths</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="va">width</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>,
      <span class="va">consumed_widths</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>
    <span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="co"># Doesn't fit first tier: try next tier</span>
    <span class="fu">deduct_width</span><span class="op">(</span><span class="va">width</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="va">consumed_widths</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span></pre></div>
</div>
<div id="next-steps" class="section level3">
<h3 class="hasAnchor">
<a href="#next-steps" class="anchor"></a>Next steps</h3>
<ul>
<li>Implement <code>colonnade2()</code>
</li>
<li>Test coverage per file</li>
<li>Improve output:
<ul>
<li>Tibble-local options for precision</li>
<li>Classes for numeric and string, use {formattable}</li>
<li>Multi-stage output for packed data frames
<ul>
<li>Reuse names/indices from left-hand side pillar if available</li>
</ul>
</li>
<li>Arrays!</li>
<li>Show number of rows if known</li>
<li>Show columns that are abbreviated in full</li>
</ul>
</li>
<li>Look for FIXMEs</li>
</ul>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="http://krlmlr.info">Kirill Müller</a>, <a href="http://hadley.nz">Hadley Wickham</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
